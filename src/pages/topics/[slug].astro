---
import Layout from '../../layouts/Layout.astro';
import { getPublishedPosts } from '../../lib/notion';
import type { Post } from '../../lib/notion';

export const prerender = false;

// Cache for 12 hours
Astro.response.headers.set('Cache-Control', 'public, max-age=0, s-maxage=43200, stale-while-revalidate=86400');

const { slug } = Astro.params;
const tag = decodeURIComponent(slug || '');

const posts = await getPublishedPosts();
const filteredPosts = posts.filter(post => 
  post.tags.some(t => t.toLowerCase() === tag.toLowerCase())
);

if (filteredPosts.length === 0) {
  return Astro.redirect('/404');
}

---

<Layout title={`${tag} - Digital Garden`}>
  <header class="mb-10">
    <h1 class="text-[33px] font-medium tracking-[-0.01em] text-text-main capitalize">{tag}</h1>
    <hr class="border-ui-border my-10" />
  </header>

  <ul class="flex flex-col gap-3">
    {filteredPosts.map((post) => (
      <li>
        <a href={`/${post.slug}`} class="group flex items-baseline gap-3 hover:text-text-muted transition-colors no-underline">
          <span class="text-text-muted shrink-0 text-[16px]">
            {new Date(post.date).toLocaleDateString('en-US', { year: 'numeric' })} Â· {new Date(post.date).toLocaleDateString('en-US', { month: '2-digit' })}
          </span>
          <span class="text-text-main group-hover:text-text-muted transition-colors">
            {post.title}
          </span>
        </a>
      </li>
    ))}
  </ul>
</Layout>
