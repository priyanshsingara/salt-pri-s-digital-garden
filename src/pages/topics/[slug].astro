---
import Layout from '../../layouts/Layout.astro';
import { getPublishedPosts } from '../../lib/notion';
import type { Post } from '../../lib/notion';
import BlogCard from '../../components/BlogCard';

export const prerender = false;

// Cache for 12 hours
Astro.response.headers.set('Cache-Control', 'public, max-age=0, s-maxage=43200, stale-while-revalidate=86400');

const { slug } = Astro.params;
const tag = decodeURIComponent(slug || '');

const posts = await getPublishedPosts();
const filteredPosts = posts.filter(post => 
  post.tags.some(t => t.toLowerCase() === tag.toLowerCase())
);

if (filteredPosts.length === 0) {
  return Astro.redirect('/404');
}

---

<Layout title={`${tag} - Digital Garden`}>
  <div class="flex flex-col gap-[44px] mt-[44px]">
    <header class="flex flex-col gap-[4px]">
      <h1 class="text-[32px] leading-[1.5] tracking-[-0.32px] font-semibold !m-0">
        <span class="text-text-muted">topics</span> <span class="text-text-muted">/</span> <span class="text-text-main">{tag}</span>
      </h1>
      <p class="text-[18px] leading-[1.5] !text-text-muted text-left !m-0">
        {filteredPosts.length} {filteredPosts.length === 1 ? 'entry' : 'entries'} about this topic
      </p>
    </header>

    <div class="border border-ui-border rounded-[12px] overflow-hidden flex flex-col gap-[6px] w-full">
      {filteredPosts.map((post) => (
        <BlogCard
            slug={post.slug}
            title={post.title}
            date={post.date}
        />
      ))}
    </div>
  </div>
</Layout>
