---
import Layout from '../../layouts/Layout.astro';
import { getPublishedPosts } from '../../lib/notion';
import type { Post } from '../../lib/notion';

export const prerender = false;

// Aggressive caching: fast delivery (stale), immediate background update
Astro.response.headers.set('Cache-Control', 'public, max-age=0, s-maxage=1, stale-while-revalidate=59');

const { slug } = Astro.params;
const tag = decodeURIComponent(slug || '');

const posts = await getPublishedPosts();
const filteredPosts = posts.filter(post => 
  post.tags.some(t => t.toLowerCase() === tag.toLowerCase())
);

if (filteredPosts.length === 0) {
  return Astro.redirect('/404');
}

---

<Layout title={`${tag} - Digital Garden`}>
  <header class="mb-12">
    <div class="text-secondary text-sm mb-2">Topic</div>
    <h1 class="text-3xl font-bold capitalize">{tag}</h1>
  </header>

  <ul class="flex flex-col gap-8">
    {filteredPosts.map((post) => (
      <li>
        <a href={`/${post.slug}`} class="group block">
          <div class="flex flex-col sm:flex-row sm:items-baseline justify-between gap-1 mb-1">
            <h2 class="text-lg font-medium text-ink group-hover:text-secondary transition-colors m-0">
              {post.title}
            </h2>
            <span class="text-secondary text-sm shrink-0 font-mono">
              {new Date(post.date).toLocaleDateString('en-US', { year: 'numeric', month: 'numeric' })}
            </span>
          </div>
        </a>
      </li>
    ))}
  </ul>
</Layout>
