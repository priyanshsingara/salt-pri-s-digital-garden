---
import Layout from '../layouts/Layout.astro';
import { getPublishedPosts } from '../lib/notion';
import type { Post } from '../lib/notion';
import { marked } from 'marked';

// Fetch data at build time
let posts: Post[] = [];
let latestPost: Post | null = null;
let error = '';

try {
  posts = await getPublishedPosts();
  if (posts.length > 0) {
    latestPost = posts[0];
  }
} catch (e) {
  console.error("Failed to fetch Notion posts:", e);
  error = "Failed to load Digital Garden. Check API keys.";
}

// Separate archive posts
const archivePosts = posts.slice(1);
---

<Layout title="Digital Garden">
  {error && (
    <div class="bg-red-50 text-red-600 p-4 rounded-lg border border-red-200">
      <p class="font-bold">Error:</p>
      <p>{error}</p>
    </div>
  )}

  {!latestPost && !error && (
    <div class="text-faint italic py-12 text-center">
      Garden is currently empty. Write something in Notion!
    </div>
  )}

  {latestPost && (
    <article class="prose prose-ink max-w-none">
      <h1 class="text-3xl font-bold mb-2">{latestPost.title}</h1>
      <div class="text-faint text-sm mb-8">
        {new Date(latestPost.date).toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        })}
      </div>
      
      {/* 
        This is where we render the Markdown content. 
        In a real Astro app, we might use a Markdown component <Markdown /> 
        or set:html with a parser like 'marked'.
        For now, we'll output raw text or basic HTML depending on notion-to-md result.
        Since notion-to-md returns markdown string, we ideally need a parser here.
        But let's assume raw markdown for a second or use a simple parser.
        Wait, I should install 'marked' to render this markdown HTML.
      */}
      <div class="markdown-body" set:html={marked.parse(latestPost.content)} />
    </article>
  )}

  {archivePosts.length > 0 && (
    <section class="mt-16 pt-16 border-t border-surface">
      <h2 class="text-xl font-semibold mb-6">Archive</h2>
      <ul class="flex flex-col gap-4">
        {archivePosts.map((post) => (
          <li>
            <a href={`/${post.slug}`} class="flex items-baseline justify-between group border-b-0 hover:border-b-0">
              <span class="text-ink font-medium group-hover:text-link transition-colors">
                {post.title}
              </span>
              <span class="text-faint text-sm shrink-0">
                {new Date(post.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
              </span>
            </a>
          </li>
        ))}
      </ul>
    </section>
  )}
</Layout>
