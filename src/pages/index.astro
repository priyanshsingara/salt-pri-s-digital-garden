---
import Layout from '../layouts/Layout.astro';
import { getPublishedPosts } from '../lib/notion';
import type { Post } from '../lib/notion';

export const prerender = false;
Astro.response.headers.set('Cache-Control', 'public, max-age=0, s-maxage=43200, stale-while-revalidate=86400');

// Fetch data at build time
let posts: Post[] = [];
let error = '';

try {
  posts = await getPublishedPosts();
} catch (e) {
  console.error("Failed to fetch Notion posts:", e);
  error = "Failed to load Digital Garden. Check API keys.";
}

// Get unique tags for Topics section
const allTags = posts.flatMap(post => post.tags);
const uniqueTags = [...new Set(allTags)].sort();

// Writing section (all posts)
const writingPosts = posts;
---

<Layout title="Digital Garden">
  {error && (
    <div class="bg-red-50 text-red-600 p-4 rounded-lg border border-red-200">
      <p class="font-bold">Error:</p>
      <p>{error}</p>
    </div>
  )}

  {!posts.length && !error && (
    <div class="text-text-muted italic py-12 text-center">
      Garden is currently empty. Write something in Notion!
    </div>
  )}

  {posts.length > 0 && (
    <>
      <section>
        <p class="text-xl leading-relaxed text-text-main">
          Welcome to my digital garden.
        </p>
      </section>

      <!-- Topics Section -->
      {uniqueTags.length > 0 && (
        <>
          <hr class="border-ui-border my-10" />
          <section>
            <h2 class="text-text-muted font-medium mb-6 mt-0">Topics</h2>
            <div class="flex flex-wrap gap-x-2 gap-y-2">
              {uniqueTags.map((tag, index) => (
                <>
                  <a 
                    href={`/topics/${tag.toLowerCase()}`}
                    class="text-text-main hover:text-text-muted transition-colors"
                  >
                    {tag}
                  </a>
                  {index < uniqueTags.length - 1 && <span class="text-text-muted">,</span>}
                </>
              ))}
            </div>
          </section>
        </>
      )}

      <!-- Writing Section -->
      <hr class="border-ui-border my-10" />
      <section>
        <h2 class="text-text-muted font-medium mb-6 mt-0">Writing</h2>
        <ul class="flex flex-col gap-3">
          {writingPosts.map((post) => (
            <li>
              <a href={`/${post.slug}`} class="group flex items-baseline gap-3 hover:text-text-muted transition-colors no-underline">
                <span class="text-text-muted shrink-0 text-[16px]">
                  {new Date(post.date).toLocaleDateString('en-US', { year: 'numeric' })} Â· {new Date(post.date).toLocaleDateString('en-US', { month: '2-digit' })}
                </span>
                <span class="text-text-main group-hover:text-text-muted transition-colors">
                  {post.title}
                </span>
              </a>
            </li>
          ))}
        </ul>
      </section>
    </>
  )}
</Layout>
