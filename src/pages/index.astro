---
import Layout from '../layouts/Layout.astro';
import Feed from '../components/Feed';
import { getPublishedPosts } from '../lib/notion';
import type { Post } from '../lib/notion';

export const prerender = false;
Astro.response.headers.set('Cache-Control', 'public, max-age=0, s-maxage=43200, stale-while-revalidate=86400');

let posts: Post[] = [];
let error = '';

try {
  posts = await getPublishedPosts();
} catch (e) {
  console.error("Failed to fetch Notion posts:", e);
  error = "Failed to load Digital Garden. Check API keys.";
}

// Calculate Topic Counts
const tagCounts: Record<string, number> = {};
posts.forEach(post => {
  post.tags.forEach(tag => {
    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
  });
});

const uniqueTopics = Object.entries(tagCounts)
  .map(([name, count]) => ({ name, count }))
  .sort((a, b) => a.name.localeCompare(b.name));
---

<Layout title="Priyansh Singara">
  {error && (
    <div class="bg-red-50 text-red-600 p-4 rounded-lg border border-red-200">
      <p class="font-bold">Error:</p>
      <p>{error}</p>
    </div>
  )}

  {!posts.length && !error && (
    <div class="text-text-muted italic py-12 text-center">
      Garden is currently empty. Write something in Notion!
    </div>
  )}

  {posts.length > 0 && (
    <div class="flex flex-col gap-[36px] mt-[36px]">
      <!-- Divider 1 -->
      <hr class="border-0 h-px w-full bg-ui-border" />

      <!-- Bio Section with internal 36px gap -->
      <section class="flex flex-col gap-[36px]">
        <p class="text-[18px] leading-[1.5] text-text-muted m-0">
          I design and build software products, leaning into the sweet spot where creative technology meets liberal arts. Outside work, you'll usually find me behind a camera, geeking out over typography, print design, and practicing fine art. I'm also big on coffee culture and keeping an active lifestyle.
        </p>
        
        <p class="text-[18px] leading-[1.5] text-text-muted m-0">
          Reach out via <a href="mailto:hello@priyanshsingara.com" class="text-text-main hover:text-text-muted transition-colors underline decoration-ui-border underline-offset-4">email</a> or <a href="https://cal.com/priyanshsingara" class="text-text-main hover:text-text-muted transition-colors underline decoration-ui-border underline-offset-4">schedule time here.</a>
        </p>
      </section>

      <!-- Divider 2 -->
      <hr class="border-0 h-px w-full bg-ui-border" />

      <!-- Feed (Tabs + Card Container) -->
      <Feed client:load posts={posts} topics={uniqueTopics} />
    </div>
  )}
</Layout>
