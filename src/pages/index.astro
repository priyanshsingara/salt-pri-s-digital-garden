---
import Layout from '../layouts/Layout.astro';
import { getPublishedPosts } from '../lib/notion';
import type { Post } from '../lib/notion';
import { marked } from 'marked';

// Fetch data at build time
let posts: Post[] = [];
let latestPost: Post | null = null;
let error = '';

try {
  posts = await getPublishedPosts();
  if (posts.length > 0) {
    latestPost = posts[0];
  }
} catch (e) {
  console.error("Failed to fetch Notion posts:", e);
  error = "Failed to load Digital Garden. Check API keys.";
}

// Get unique tags for Topics section
const allTags = posts.flatMap(post => post.tags);
const uniqueTags = [...new Set(allTags)].sort();

// Writing section (all posts)
const writingPosts = posts;
---

<Layout title="Digital Garden">
  {error && (
    <div class="bg-red-50 text-red-600 p-4 rounded-lg border border-red-200">
      <p class="font-bold">Error:</p>
      <p>{error}</p>
    </div>
  )}

  {!latestPost && !error && (
    <div class="text-secondary italic py-12 text-center">
      Garden is currently empty. Write something in Notion!
    </div>
  )}

  {latestPost && (
    <>
      <!-- Latest Section -->
      <section class="mb-16">
        <h2 class="text-sm font-medium text-secondary uppercase tracking-wider mb-6">Latest</h2>
        <article class="prose prose-ink max-w-none">
          <h1 class="text-3xl font-medium mb-3 tracking-tight">{latestPost.title}</h1>
          <div class="text-secondary text-sm mb-8">
            {new Date(latestPost.date).toLocaleDateString('en-US', { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric' 
            })}
          </div>
          
          <div class="markdown-body" set:html={marked.parse(latestPost.content)} />
        </article>
      </section>

      <!-- Topics Section -->
      {uniqueTags.length > 0 && (
        <section class="mb-16">
          <h2 class="text-sm font-medium text-secondary uppercase tracking-wider mb-6">Topics</h2>
          <div class="flex flex-wrap gap-x-2 gap-y-2">
            {uniqueTags.map((tag, index) => (
              <>
                <a 
                  href={`/topics/${tag.toLowerCase()}`}
                  class="text-ink hover:text-secondary transition-colors border-b border-transparent hover:border-secondary"
                >
                  {tag}
                </a>
                {index < uniqueTags.length - 1 && <span class="text-secondary">,</span>}
              </>
            ))}
          </div>
        </section>
      )}

      <!-- Writing Section -->
      {writingPosts.length > 0 && (
        <section>
          <h2 class="text-sm font-medium text-secondary uppercase tracking-wider mb-6">Writing</h2>
          <ul class="flex flex-col gap-3">
            {writingPosts.map((post) => (
              <li>
                <a href={`/${post.slug}`} class="group flex items-baseline gap-3 hover:text-secondary transition-colors">
                  <span class="text-secondary text-sm shrink-0 font-mono">
                    {new Date(post.date).toLocaleDateString('en-US', { year: 'numeric' })} Â· {new Date(post.date).toLocaleDateString('en-US', { month: '2-digit' })}
                  </span>
                  <span class="text-ink group-hover:text-secondary transition-colors">
                    {post.title}
                  </span>
                </a>
              </li>
            ))}
          </ul>
        </section>
      )}
    </>
  )}
</Layout>
