---
import Layout from '../layouts/Layout.astro';
import { getPublishedPosts } from '../lib/notion';
import { parseContent } from '../lib/content-parser';

export const prerender = false;

// Cache control headers for ISR - 1 hour edge cache
Astro.response.headers.set('Cache-Control', 'public, max-age=0, s-maxage=3600, stale-while-revalidate=86400');

const { slug } = Astro.params;
const posts = await getPublishedPosts();
const post = posts.find(p => p.slug === slug);

if (!post) {
  return Astro.redirect('/404');
}

const allPostsSummary = posts.map(p => ({ title: p.title, slug: p.slug }));

// Build Backlink Map
const backlinks: Record<string, { title: string; slug: string; date: string }[]> = {};

posts.forEach(sourcePost => {
  // Regex for [[Target]] or [[Target|Alias]]
  const regex = /\[\[(.*?)\]\]/g;
  let match;
  while ((match = regex.exec(sourcePost.content)) !== null) {
    const linkText = match[1];
    const targetTitle = linkText.includes('|') ? linkText.split('|')[0] : linkText;
    
    const targetPost = allPostsSummary.find(p => p.title.toLowerCase() === targetTitle.toLowerCase());
    if (targetPost) {
      if (!backlinks[targetPost.slug]) {
        backlinks[targetPost.slug] = [];
      }
      if (!backlinks[targetPost.slug].find(p => p.slug === sourcePost.slug)) {
        backlinks[targetPost.slug].push({ 
          title: sourcePost.title, 
          slug: sourcePost.slug,
          date: sourcePost.date 
        });
      }
    }
  }
});

// Parse the content (Markdown -> HTML + WikiLinks)
const htmlContent = await parseContent(post.content, allPostsSummary);
const currentBacklinks = backlinks[post.slug] || [];
---

<Layout title={post.title}>
  <article class="prose max-w-none">
    <h1 class="text-[33px] font-medium tracking-[-0.01em] mb-4 text-text-main">{post.title}</h1>
    <div class="text-text-muted text-[16px] mb-12 flex items-baseline gap-4">
      <span>
        {new Date(post.date).toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        })}
      </span>
      {/* Optional: Display tags cleanly if desired, or remove if too cluttered */}
      {post.tags.length > 0 && (
         <span class="text-text-faint">•</span>
      )}
      {post.tags.length > 0 && (
        <span class="text-text-muted">{post.tags.join(', ')}</span>
      )}
    </div>
    
    <div class="markdown-body text-[19px] leading-relaxed text-text-main" set:html={htmlContent} />
  </article>

  {currentBacklinks.length > 0 && (
    <div class="mt-16 pt-8 border-t border-ui-border">
      <h3 class="text-text-muted font-medium mb-6 mt-0">Linked to this note</h3>
      <ul class="flex flex-col gap-3">
        {currentBacklinks.map(link => (
          <li>
            <a href={`/${link.slug}`} class="group flex items-baseline gap-3 hover:text-text-muted transition-colors no-underline">
               <span class="text-text-muted shrink-0 text-[16px]">
                  {new Date(link.date).toLocaleDateString('en-US', { year: 'numeric' })} · {new Date(link.date).toLocaleDateString('en-US', { month: '2-digit' })}
                </span>
              <span class="text-text-main group-hover:text-text-muted transition-colors">
                {link.title}
              </span>
            </a>
          </li>
        ))}
      </ul>
    </div>
  )}

  <div class="mt-12 pt-8 border-t border-ui-border">
    <a href="/" class="text-link hover:text-link/80 transition-colors">← Back to Index</a>
  </div>
</Layout>
